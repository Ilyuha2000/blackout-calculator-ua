<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ê—Ä—Ö–∏–≤ –æ—Ç–∫–ª—é—á–µ–Ω–∏–π —Å–≤–µ—Ç–∞</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; padding: 20px; color: #333; }
        .container, .history-card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 450px; margin-bottom: 20px; }
        
        .pending-box { background: #fff4e5; border: 2px dashed #ffa94d; padding: 20px; border-radius: 12px; text-align: center; }
        .date-input-row { margin-bottom: 15px; }
        input[type="date"] { padding: 8px; border-radius: 8px; border: 1px solid #ccc; font-family: inherit; }
        
        .input-group { display: flex; justify-content: center; gap: 10px; margin: 15px 0; }
        input[type="number"] { width: 65px; padding: 10px; border: 1px solid #ccc; border-radius: 8px; text-align: center; font-size: 1.2rem; }
        
        .btn { border: none; padding: 12px; border-radius: 10px; font-weight: bold; cursor: pointer; width: 100%; transition: 0.2s; }
        .btn-start { background: #ff922b; color: white; }
        .btn-end { background: #40c057; color: white; }
        
        .day-group { margin-bottom: 20px; border: 1px solid #e9ecef; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .day-header { background: #e7f5ff; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #d0ebff; }
        .day-date { font-weight: bold; color: #1971c2; }
        .day-total { background: #1971c2; color: white; padding: 2px 10px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; }
        
        .interval-item { padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; background: white; border-bottom: 1px solid #f1f3f5; }
        .interval-time { color: #495057; font-size: 0.95rem; }
        .interval-dur { font-weight: bold; color: #e03131; font-size: 0.9rem; }

        .btn-del { color: #dee2e6; cursor: pointer; border: none; background: none; font-size: 1.2rem; margin-left: 10px; }
        .btn-del:hover { color: #fa5252; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center; margin-top:0">‚ö°Ô∏è –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è —Å–≤–µ—Ç–∞</h2>
    <div id="pendingSection" class="pending-box"></div>
</div>

<div class="history-card">
    <h3 style="margin-top:0">üìÖ –ò—Å—Ç–æ—Ä–∏—è –∏ –ò—Ç–æ–≥–∏</h3>
    <div id="history-content"></div>
</div>

<script>
    window.onload = () => { renderPending(); renderHistory(); };

    function renderPending() {
        const section = document.getElementById('pendingSection');
        const active = JSON.parse(localStorage.getItem('activeOff') || 'null');
        const today = new Date().toISOString().split('T')[0];

        if (!active) {
            section.innerHTML = `
                <div class="date-input-row">
                    <label style="font-size:0.8rem; color:#888">–î–ê–¢–ê:</label><br>
                    <input type="date" id="targetDate" value="${today}">
                </div>
                <b style="color:#d9480f">–ù–∞—á–∞–ª–æ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è</b>
                <div class="input-group">
                    <input type="number" id="h1" placeholder="–ß–ß"> : <input type="number" id="m1" placeholder="–ú–ú">
                </div>
                <button class="btn btn-start" onclick="saveStart()">–ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –í–´–ö–õ</button>`;
        } else {
            section.innerHTML = `
                <div style="margin-bottom:10px; font-size:0.9rem">
                    <b>–î–∞—Ç–∞:</b> ${active.dateDisp}<br>
                    <b style="color:#d9480f">–í—ã–∫–ª—é—á–∏–ª–∏ –≤ ${active.h}:${active.m}</b>
                </div>
                <div class="input-group">
                    <input type="number" id="h2" placeholder="–ß–ß"> : <input type="number" id="m2" placeholder="–ú–ú">
                </div>
                <button class="btn btn-end" onclick="saveEnd()">–ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –í–ö–õ</button>
                <p onclick="cancelActive()" style="color:#fa5252; cursor:pointer; font-size:0.8rem; margin-top:10px; text-decoration:underline">–£–¥–∞–ª–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫</p>`;
        }
    }

    function saveStart() {
        const h = document.getElementById('h1').value;
        const m = document.getElementById('m1').value || "00";
        const dateVal = document.getElementById('targetDate').value;
        if (!h || !dateVal) return alert("–í—ã–±–µ—Ä–∏ –¥–∞—Ç—É –∏ —á–∞—Å!");

        const d = new Date(dateVal);
        const dateDisp = d.toLocaleDateString('ru-RU');

        localStorage.setItem('activeOff', JSON.stringify({ 
            h: h.padStart(2,'0'), 
            m: m.padStart(2,'0'), 
            dateRaw: dateVal,
            dateDisp: dateDisp 
        }));
        renderPending();
    }

    function saveEnd() {
        const active = JSON.parse(localStorage.getItem('activeOff'));
        const h2 = document.getElementById('h2').value;
        const m2 = document.getElementById('m2').value || "00";
        if (!h2) return alert("–í–≤–µ–¥–∏ –≤—Ä–µ–º—è –≤–∫–ª—é—á–µ–Ω–∏—è!");

        const startMin = parseInt(active.h) * 60 + parseInt(active.m);
        let endMin = parseInt(h2) * 60 + parseInt(m2);
        
        // –ï—Å–ª–∏ –ø–µ—Ä–µ—à–ª–æ —á–µ—Ä–µ–∑ –ø–æ–ª–Ω–æ—á—å
        if (endMin < startMin) endMin += 1440;

        const diff = endMin - startMin;
        const history = JSON.parse(localStorage.getItem('lightLogs') || '[]');
        
        history.push({
            id: Date.now(),
            dateRaw: active.dateRaw, // –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
            dateDisp: active.dateDisp, // –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã
            start: `${active.h}:${active.m}`,
            end: `${h2.padStart(2,'0')}:${m2.padStart(2,'0')}`,
            minutes: diff
        });

        // –°–æ—Ä—Ç–∏—Ä—É–µ–º: —Å–Ω–∞—á–∞–ª–∞ –ø–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ –≤–≤–µ—Ä—Ö—É), –ø–æ—Ç–æ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞—á–∞–ª–∞
        history.sort((a, b) => b.dateRaw.localeCompare(a.dateRaw) || b.start.localeCompare(a.start));

        localStorage.setItem('lightLogs', JSON.stringify(history));
        localStorage.removeItem('activeOff');
        renderPending();
        renderHistory();
    }

    function renderHistory() {
        const logs = JSON.parse(localStorage.getItem('lightLogs') || '[]');
        const container = document.getElementById('history-content');
        
        if (!logs.length) {
            container.innerHTML = '<p style="text-align:center; color:#999">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</p>';
            return;
        }

        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∑–∞–ø–∏—Å–∏ –ø–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–π –¥–∞—Ç–µ
        const groups = logs.reduce((acc, log) => {
            if (!acc[log.dateDisp]) acc[log.dateDisp] = { items: [], total: 0 };
            acc[log.dateDisp].items.push(log);
            acc[log.dateDisp].total += log.minutes;
            return acc;
        }, {});

        // –í—ã–≤–æ–¥–∏–º –≥—Ä—É–ø–ø—ã
        container.innerHTML = Object.keys(groups).map(date => {
            const group = groups[date];
            return `
                <div class="day-group">
                    <div class="day-header">
                        <span class="day-date">${date}</span>
                        <span class="day-total">–ò—Ç–æ–≥: ${formatTime(group.total)}</span>
                    </div>
                    ${group.items.map(item => `
                        <div class="interval-item">
                            <span class="interval-time">üïí ${item.start} ‚Äî ${item.end}</span>
                            <div style="display:flex; align-items:center">
                                <span class="interval-dur">${formatTime(item.minutes)}</span>
                                <button class="btn-del" onclick="deleteLog(${item.id})">‚úï</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }).join('');
    }

    function formatTime(min) {
        const h = Math.floor(min / 60);
        const m = min % 60;
        return `${h}—á ${m}–º`;
    }

    function deleteLog(id) {
        let logs = JSON.parse(localStorage.getItem('lightLogs') || '[]');
        logs = logs.filter(l => l.id !== id);
        localStorage.setItem('lightLogs', JSON.stringify(logs));
        renderHistory();
    }

    function cancelActive() { 
        if(confirm("–£–¥–∞–ª–∏—Ç—å —Ç–µ–∫—É—â–∏–π —á–µ—Ä–Ω–æ–≤–∏–∫?")) {
            localStorage.removeItem('activeOff'); 
            renderPending(); 
        }
    }
</script>

</body>
</html>
